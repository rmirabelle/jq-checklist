
(function($){$.checklist=$.checklist||{version:'1.0.0'};$.fn.checklist=function(options,callback){if(!$.fn.metadata){alert('jQuery checklist plugin requires jQuery metadata plugin.');return;}
$.metadata.setType('class');var api=this.data('checklist');if(api){if(typeof(callback)=='function'){callback.call(this);}
return api;}
var defaults={title:'',prefix:'checklist-',header:true,search:true,summary:true,footer:true,readonly:false,on_check:null};var settings=$.extend(true,{},defaults,options);this.each(function(){settings=$.extend(true,{},settings,$(this).metadata());api=new Checklist($(this),settings);$(this).data('checklist',api);});if(typeof(callback)=='function'){callback.call(this);}
return api;};function Checklist(el,sett){var element=el;var id=element.attr('id');var prefix=sett.prefix;create_line_items();var frame=build_frame();var header=sett.header?build_header():false;var search=sett.search?build_search():false;var summary=sett.summary&&!sett.readonly?build_summary():false;var footer=sett.footer&&!sett.readonly?build_footer():false;var component=null;element.wrap(frame).after(footer).after(summary).before(header).before(search);element.checkreplace({oncheck:check_replace_oncheck,readonly:sett.readonly});update_summary(element.data('checkreplace').get_checked_count());component=element.parent();component.itemfilter({search:'input',items:'li',filter_on:'label'});$.extend(this,{clear_filter:function(){component.data('itemfilter').clear_search();},get_checked:function(){component.data('itemfilter').clear_search();return element.find('input:checked');},get_num_checked:function(){return element.data('checkreplace').get_checked_count();},set_checked:function(arr_values){element.data('checkreplace').set_checked(arr_values);},bubble_checked:function(){var ul=$('ul',element),all=ul.find('li').detach();all.each(function(){var label=$('label',$(this));if(label.hasClass('check')){$(this).appendTo(ul)}});all.each(function(){var label=$('label',$(this));if(label.hasClass('uncheck')){$(this).appendTo(ul)}});}});function create_line_items(){element.find(':checkbox').each(function(){$(this).addClass('checkreplace');var cb_value=$(this).attr('value');var meta=$(this).metadata();var cb_meta_label=meta.label||cb_value;var cb_meta_tip=meta.tip||false;var cb_meta_title=meta.title||false;var label=$('<label>').html(cb_meta_label);var li=$('<li>');if(cb_meta_title)li.attr('title',cb_meta_title);$(this).wrap(li).before(label);if(cb_meta_tip){var tip=build_tip(cb_meta_tip);label.append(tip);}});$('li',element).wrapAll($('<ul>'));element.addClass(prefix+'body');}
function check_replace_oncheck(api){var num=api.get_checked_count();if(typeof sett.on_check=='function'){sett.on_check.call(api,num);}
update_summary(num);}
function update_summary(checked_count){element.parent().find('.'+prefix+'summary').html(checked_count+' selected');}
function build_tip(str){return'<a href="#" class="tip" title="'+str+'"></a>';}
function build_frame(){var frame=$('<div>');frame.attr('id',id+'-frame');frame.addClass(prefix+'frame');return frame;}
function build_header(){var header=$('<div>');header.addClass(prefix+'header');header.html(sett.title);return header;}
function build_search(){var s=$('<div><input type="text">');s.addClass(prefix+'search');return s;}
function build_summary(){var summary=$('<div>');summary.addClass(prefix+'summary');summary.html('0 selected');return summary;}
function build_footer(){var footer=$('<div>Select <a href="#" class="all">All</a> | <a href="#" class="none">None</a>');footer.addClass(prefix+'footer');$('.all',footer).click(function(e){e.preventDefault();var api=element.data('checkreplace');api.check_all(false);});$('.none',footer).click(function(e){e.preventDefault();var api=element.data('checkreplace');api.check_none();});return footer;}}
$.fn.checkreplace=function(options){var checkreplace=this.data('checkreplace');if(checkreplace)return checkreplace;var defaults={checkclass:'checkreplace',onclass:'check',offclass:'uncheck',noneclass:'nonechecked',readonly:false,oncheck:function(){}};var settings=$.extend(true,{},defaults,options);this.each(function(){checkreplace=new CheckReplace($(this),settings);$(this).data("checkreplace",checkreplace);});return checkreplace;};function CheckReplace(element,settings){var list=$(element);var labels=list.find('label');var checked_count=0;if(settings.readonly){list.addClass('readonly');}
$.extend(this,{check_all:function(visible_only){if(typeof(visible_only=='undefined')){visible_only=true;}
checked_count=0;var should_check=true;labels.each(function(){if(visible_only){should_check=$(this).is(':visible');}
if(should_check){checked_count++;$(this).removeClass(settings.offclass).addClass(settings.onclass);$(this).next(':checkbox').attr('checked',true);}});check_checked_count();oncheck(this);},check_none:function(){checked_count=0;labels.each(function(){$(this).removeClass(settings.onclass).addClass(settings.offclass);$(this).next(':checkbox').attr('checked',false);});check_checked_count();oncheck(this);},rewire:function(){wire();},set_checked:function(arr){checked_count=0;var cb;labels.each(function(){cb=$(this).next(':checkbox');$(this).removeClass(settings.onclass).addClass(settings.offclass);cb.attr('checked',false);var len=arr.length;for(var x=0;x<len;x++){if(cb.val()==arr[x]){checked_count++;$(this).removeClass(settings.offclass).addClass(settings.onclass);$(this).next(':checkbox').attr('checked',true);}}});check_checked_count();oncheck(this);},get_checked_count:function(){return checked_count;}});function wire(){labels.each(function(){var label=$(this);var check=label.next(':checkbox');if(check.length>0&&check.hasClass(settings.checkclass)){check.hide();if(check.is(':checked')){checked_count++;label.removeClass(settings.offclass).addClass(settings.onclass);}else{label.removeClass(settings.onclass).addClass(settings.offclass);}
if(!settings.readonly){label.click(function(e){e.preventDefault();toggle_checkbox(check);toggle_label(label);check_checked_count();oncheck(this);});}}});}
wire();check_checked_count();function oncheck(target){settings.oncheck.call(target,element.data('checkreplace'));}
function check_checked_count(){if(checked_count>0){list.removeClass(settings.noneclass);}else{list.addClass(settings.noneclass);}}
function toggle_checkbox(check){if(check.is(':checked')){check.attr('checked',false);}else{check.attr('checked',true);}
if(check.is(':checked')){checked_count++;}else{checked_count--;}}
function toggle_label(label){if(label.hasClass(settings.onclass)){label.removeClass(settings.onclass).addClass(settings.offclass);}else{label.removeClass(settings.offclass).addClass(settings.onclass);}}}
$.fn.itemfilter=function(options){var filter=this.data('itemfilter');if(filter)return filter;var defaults={items:'option',filter_on:'text',search_box:'input:text',css_off:'#999',css_on:'#000'};var settings=$.extend(true,{},defaults,options);this.each(function(){filter=new ItemFilter(settings);filter.init($(this));$(this).data('itemfilter',filter);});return filter;};function ItemFilter(conf){var element=null;var settings=conf;var items=[];var regex=new RegExp();var matches=[];var val='';var pattern='';var container='';$.extend(this,{init:function(el){element=el;items=element.find(settings.items);container=items.parent();build_search();},clear_search:function(){element.find(settings.search_box).val('');search("");}});function build_search(){var search_box=element.find(settings.search_box);if(!search_box.length){return;}
search_box.css({color:settings.css_off}).val('search');search_box.click(function(){$(this).css({color:settings.css_on}).val('');});search_box.blur(function(){if($(this).val()==''){$(this).css({color:settings.css_off}).val('search');}});search_box.live('keyup',function(e){if(e.which==16)return;search($(this).val());});}
function build_list(arr){items.each(function(){$(this).detach();});var len=arr.length;for(var x=0;x<len;x++){container.append(arr[x]);}}
function get_value(item){switch(settings.filter_on){case'value':val=$(item).attr('value');break;case'text':val=$(item).text();break;case'label':val=$(item).find('label:first').text();break;default:throw('Cannot filter on '+settings.filter_on);}
return val;}
function search(str){if(str.length==0){build_list(items);}else{str=str.split('\\').join('\\\\');matches.length=0;pattern="^"+str;regex=new RegExp(pattern,'i');var len=items.length;for(var x=0;x<len;x++){val=get_value(items[x]);if(val.match(regex)){matches.push(items[x]);}}
build_list(matches);}}}})(jQuery);